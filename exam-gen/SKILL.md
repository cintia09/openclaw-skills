---
name: exam-gen
description: |
  通用试卷生成技能。支持任意年级、科目、考试类型的模拟试卷生成。
  当用户提到出题、模拟卷、期中/期末考试、单元测试、试卷生成时触发。
---

# 通用试卷生成（exam-gen）

> 目标：在**给定科目/年级/考试范围**的前提下，生成**结构与分值严格匹配**、答案唯一、难度梯度合理的模拟试卷。

## 1. 触发场景

- "帮我出一套/两套……试卷/模拟卷/单元卷/期中/期末/一模二模"
- "按XX地区/XX学校/XX卷型结构出题"
- "需要 Markdown / LaTeX 版本的试卷（带答案解析/不带解析）"

## 2. 输入（必须收集的信息）

### 必填
1) **科目**（如：数学/物理/化学/英语/历史等）
2) **年级/学段**（如：高二上/初三/高一必修2）
3) **考试范围**（如："高二上期末""初三一模""必修1第3章单元测试"）

### 选填（强烈建议）
4) **题型结构与分值**（若用户提供，必须严格遵循；例：8单选+3多选+3填空+5解答）
5) **难度要求**（基础/中档/拔高比例；或"偏基础""冲刺难"）
6) **是否需要答案/解析**（答案卡 / 详解 / 关键步骤）
7) **输出格式**（默认 Markdown；可选 LaTeX）
8) **地区/卷型偏好**（如：新高考I卷、江苏卷、北京卷、学校自命题）


## 3. 若未提供结构：先"查标准结构"再出题

当用户未指定"题型结构/分值"时：

1) 使用 `web_search` 搜索关键词（示例）：
   - `"{地区}" "{年级}" "{学期}" "{科目}" 期末 试卷 题型 分值`
   - `"{年级}" "{科目}" 模拟卷 题型结构 选择题 填空题 解答题 分值`
   - 若是成熟考试（中考/高考/学考/竞赛），优先搜"官方/权威"结构
2) 将搜索到的结构整理成**可执行的规格表**：
   - 题型列表、每题分值、题数、小题总分、整卷总分、时长
3) 若仍不确定：向用户发起澄清（至少确认"总分/时长/题型分区"）。

> 原则：**宁可多问一句，也不凭空编结构**。结构错误会导致整卷不可用。


## 3.5 出题前必做功课（三查）

**每次生成试卷前，必须完成"三查"：**

### 一查：考试大纲/课程标准
- 确定该年级该学期对应的教材版本和册次
- 确定考试范围（哪些章节在范围内，哪些不在）
- 注意不同地区可能用不同教材（人教A版 vs 苏教版 vs 北师大版）
- 搜索关键词示例：`"{地区} {年级} {学期} 数学 考试范围 教学进度"`
- **如果 `references/` 目录下已有该科目该年级的参考资料文件，优先读取，不必重新搜索**

### 二查：教科书内容
- 读取或搜索教材目录，了解每章的具体知识点
- 明确哪些是重点（必考）、哪些是了解（选考）
- 确保出题知识点在教材范围内，不超纲
- 搜索关键词示例：`"{教材版本} {册次} 目录 知识点"`

### 三查：最新真实试卷
- 搜索最近1-2年的同类型真实试卷
- 分析：题型结构、知识点分布比例、难度梯度、典型出题风格
- 作为子代理prompt的参考素材（提取文本，不是直接给PDF）
- 搜索关键词示例：`"{年份} {地区} {年级} {学期} {科目} 期末/模拟 试卷"`
- 如果 `gaokao/下载试卷/` 目录下有相关真题PDF，用 pdfplumber 提取文本

### 参考资料存储
- 整理后的参考资料存入 `skills/exam-gen/references/{年级}_{学期}_{科目}_参考资料.md`
- 下次同类任务直接读取，无需重新搜索
- 参考资料包括：教材目录、知识点清单、真题分析、出题注意事项

### 子代理prompt中必须包含
- 教材对应的章节范围
- 考试知识点清单（含权重/频次）
- 真实试卷的题型和风格描述（不是原题）


## 4. 生成策略：多模型交叉生成 + 交叉验收 + 组卷

### 4.1 三路并行生成

用三个不同模型各自独立生成一份完整试卷（题目+答案+解析）：

| 子代理 | 推荐模型 | 说明 |
|--------|----------|------|
| 卷A | `openai/gpt-5.2` | 擅长长内容生成 |
| 卷B | `github-copilot/claude-opus-4.5` | 推理严谨 |
| 卷C | `github-copilot/claude-opus-4.6` | 综合能力强 |

每个子代理的 prompt **必须包含**（完整约束列表）：
1. 完整的结构规格表（题型、题数、每题分值、总分、时长）
2. 知识点范围和覆盖要求
3. 难度分布要求（基础/中等/较难比例）
4. 答案分布要求（单选ABCD均匀，多选各不相同）
5. "严禁在解析中出现'修正题目''重新设计''答案应为'等字样——如果你发现题目有问题，直接改好题目再输出，不要留下修改痕迹"
6. "每道选择题必须有且仅有一个正确答案（单选）或一组正确答案（多选），输出前自行验算"
7. "输出LaTeX+TikZ格式，需要图形的题目必须画TikZ图（函数图像、几何图形、立体图形、圆锥曲线等），数学至少10个TikZ图"
8. "用分段写入法（cat > + cat >>）写LaTeX文件，写完后用xelatex编译验证"

- 串行 spawn（一个完成再下一个），避免 provider slot 竞争

### 4.2 交叉质询（核心环节，必须做）

收齐三份试卷后，进行**逐题交叉质询**。这不是简单的"挑最好的"，而是层层追问式的深度审查。

#### 质询流程（5轮）

**第1轮：结构核验**
- 三份试卷的题型/题数/分值是否都符合规格？
- 不符合的直接淘汰该份的对应部分

**第2轮：逐题答案比对**
对每道题，比对三份的答案：
- **三份一致** → 高置信度采纳，但仍需抽验计算过程
- **两份一致、一份不同** → 追问链：
  ```
  分歧: 卷A和卷C答案为B，卷B答案为D
  Why 1: 卷B的解题过程哪一步和A/C不同？
  → 定位具体分歧步骤
  Why 2: 该步骤的推导是否正确？代入验算
  → 确认谁对谁错
  Why 3: 错误版本的题目本身是否有问题（条件不足/多解）？
  → 如果是题目问题，三份可能都不对
  结论: 采纳正确版本，或修正题目后重新求解
  ```
- **三份都不同** → 红旗！题目很可能有歧义或过难：
  ```
  Why 1: 三个不同答案分别是怎么得出的？
  Why 2: 题目条件是否充分？是否存在多解？
  Why 3: 如果题目有缺陷，能否微调条件使答案唯一？
  结论: 修正题目 或 从备选题库替换
  ```

**第3轮：硬伤扫描**
检查每题是否存在以下致命问题：
- 解析中出现"修正/重新设计/需要更多条件"（生成痕迹）
- 答案栏与解析结论矛盾（前后不一致）
- 物理/化学常识错误（如"椭圆的渐近线"）
- 单选题无正确选项或多个正确选项
- 填空题答案格式不明确

**第4轮：难度梯度审查**
- 整卷难度是否符合 基础50%+中等30%+较难20%？
- 是否存在前面比后面难的倒置？
- 压轴题是否真正有区分度？

**第5轮：最终组卷**
- 每道题从三份中选最优版本
- 有硬伤且无替代的题 → 现场修正（改条件/改选项/改数值）
- 修正后的题**必须重新验算答案**
- 确保选择题答案分布合理（不全选同一个）

#### 交叉质询的执行方式

推荐 spawn 一个**审查子代理**（用与生成不同的模型），给它：
1. 三份试卷的完整内容
2. 上述5轮质询模板
3. 要求输出：`{题号: {选用版本: A/B/C/修正, 问题: "...", 修正内容: "..."}}`

审查子代理完成后，再 spawn 一个**组卷子代理**，按审查结果拼装最终试卷。

### 4.4 进度汇报（必须做）

整个流程中，**主对话必须主动向用户汇报进度**，不能让用户干等无反馈。

| 时机 | 汇报内容 |
|------|----------|
| 任务启动 | "开始生成X科试卷，预计N分钟，流程：三路生成→交叉质询→组卷" |
| 每个子代理完成 | "卷A(GPT-5.2)已完成/卷B(Opus-4.5)已完成，还剩X个" |
| 交叉质询开始 | "三份试卷已收齐，开始交叉质询..." |
| 质询完成 | "质询完成，X题需修正/替换，开始组卷" |
| 最终交付 | "试卷已生成，文件路径：...，附质检摘要" |

**规则：**
- 子代理跑超过3分钟未完成 → 主动查sessions_list并汇报"还在跑，已用时X分钟"
- 多科并行时，每科完成都单独汇报
- 不要等全部做完才一次性告知，**逐步汇报**

### 4.5 Cron进度追踪（长任务必起）

试卷生成是长任务（三路生成+质询+组卷，通常15-30分钟），**必须起cron定时追踪进度**，避免主对话被阻塞、用户干等。

#### 启动方式

在spawn第一个子代理后，立即创建一个cron job：

```
cron add:
  name: "exam-progress-{科目}"
  schedule: { kind: "every", everyMs: 120000 }  # 每2分钟
  sessionTarget: "isolated"
  payload:
    kind: "agentTurn"
    message: |
      检查试卷生成进度。
      用 sessions_list 查看以下label的子代理状态：
      - {route-A-label}
      - {route-B-label}  
      - {route-C-label}
      - {review-label}（如已启动）
      - {assemble-label}（如已启动）
      
      对每个子代理：
      1. 是否已完成？（看sessions_list的状态）
      2. 如已完成，用sessions_history读最后一条消息，提取关键信息（结构是否合规、有无硬伤）
      3. 如还在跑，报告已用时间
      
      汇总后发飞书通知用户，格式：
      📝 {科目}试卷生成进度
      ✅ 路A(GPT-5.2): 已完成，结构合规
      ⏳ 路B(Opus-4.5): 进行中(已2分钟)
      ⏳ 路C(Opus-4.6): 排队中
      下一步: 等路B/C完成后启动交叉质询
      
      如果全部子代理已完成且组卷也完成，发送最终通知并自行删除此cron job（cron remove）。
    model: "github-copilot/gpt-4.1"  # 轻量模型够用
    timeoutSeconds: 60
  delivery: { mode: "none" }  # 由任务自己发飞书，不要announce
```

#### 关键规则

1. **每2分钟轮询一次**，用轻量模型（GPT-4.1），省slot
2. **cron自己发飞书通知**（用message工具），不依赖announce
3. **全部完成后自动清理**：cron job用 `cron remove` 删除自己
4. **cron的label要包含科目名**，方便识别和管理
5. **主对话不要轮询**：起了cron就放手，主对话继续响应用户其他请求

#### 何时不需要cron

- 只生成1套简单试卷（单路生成，<5分钟）→ 不需要
- 用户在旁边等着实时聊天 → 主对话直接汇报即可
- **三路生成+交叉质询的标准流程 → 必须起cron**

### 4.6 组卷输出

- 以审查结果为蓝本，从三版中取最优题拼装
- 所有修正过的题标注"[已修正]"（仅内部标注，最终交付版删除）
- 最终试卷必须是**干净的、无修改痕迹的**完整文档
- 答案与解析独立成区，方便出"无答案版"


## 5. 质检清单（交付前必过）

### 5.1 结构与分值
- [ ] 各题型题数正确
- [ ] 各题型小计分正确
- [ ] 总分正确
- [ ] 题号连续、无缺号/重复号

### 5.2 答案唯一性与可判定性
- [ ] 单选：只有一个正确选项（避免"AB都对/条件不足"）
- [ ] 多选：正确集合唯一、无歧义（避免"解析里改口/答案摇摆"）
- [ ] 填空：答案形式明确（是否允许多解、是否需最简）

### 5.3 难度梯度
- [ ] 基础题约 50% / 中档 30% / 难题 20%（可按用户要求调整）
- [ ] 后面题目整体更综合，不要前易后乱

### 5.4 题面质量与图形
- [ ] 需要配图的题目都有TikZ图形（不能写"如图"但无图）
- [ ] TikZ图形数量达标（数学≥10，物理≥8，化学≥5）
- [ ] TikZ图形与题意一致（坐标、标注、方向正确）
- [ ] LaTeX编译无错误（xelatex通过）
- [ ] 不出现"让我们重新设计/修正题目/答案应为…"等生成痕迹
- [ ] 物理/化学单位齐全，数值合理


## 5.5 进度汇报（必须做）

生成试卷是长任务，**必须主动向用户汇报进度**：

- 每个子代理启动时：告知用户"第X路（模型名）已开始"
- 每个子代理完成时：简要汇报结果（结构是否合规、文件大小、发现的问题）
- 交叉质询开始/结束时：汇报分歧点数量和处理结果
- 组卷完成时：汇报最终试卷状态

**不要让用户干等无反馈。** 哪怕只是一句"第2路完成了，正在等第3路"也比沉默好。

### 5.6 PDF交付前检查
- [ ] 用 pandoc+xelatex 生成PDF，确认编译无错误
- [ ] 检查PDF文件大小（正常应>50KB，<10KB说明内容缺失）
- [ ] 公式渲染正确（不是原始TeX文本）
- [ ] 中文显示正常（不是方框或乱码）
- [ ] 页面布局合理（不要一页只有几行）

## 6. 输出规范

### ⚠️ 默认输出格式：LaTeX + TikZ（必须带图）

**试卷必须用LaTeX+TikZ生成，不要用Markdown。** Markdown无法嵌入图形，而真实试卷（尤其数学/物理/化学）必须有大量配图。

#### LaTeX+TikZ要求
- 产出：`.tex` 源文件 → `xelatex` 编译 → PDF
- **必须包含TikZ图形**，数量要求：
  - 数学：≥10个图（函数曲线、平面几何、立体几何、圆锥曲线等）
  - 物理：≥8个图（力学示意图、电路图、光路图、运动轨迹等）
  - 化学：≥5个图（有机结构式、实验装置示意、晶体结构等）
  - 其他科目：根据实际需要
- **模板参考**：`/root/.openclaw/workspace/gaokao/LaTeX版/` 目录下有现成模板
- **排版规范**：
  - 使用 `ctex` 宏包处理中文
  - 使用 `tikz`、`pgfplots` 画图
  - 使用 `geometry` 控制页边距
  - 试卷题目和答案解析分页（`\newpage`）

#### LaTeX文件结构模板
```latex
\documentclass[12pt,a4paper]{article}
\usepackage[UTF8]{ctex}
\usepackage{geometry}
\usepackage{amsmath,amssymb,amsthm}
\usepackage{tikz,pgfplots}
\usepackage{enumitem}
\usepackage{fancyhdr}
\usetikzlibrary{calc,patterns,angles,quotes,arrows.meta,3d,positioning}
\pgfplotsset{compat=1.18}
\geometry{left=2.5cm,right=2.5cm,top=2.5cm,bottom=2.5cm}
% ... 题目内容 ...
% \newpage
% ... 参考答案与解析 ...
\end{document}
```

#### 编译命令
```bash
xelatex -interaction=nonstopmode 试卷.tex
# 如需交叉引用，跑第二遍
xelatex -interaction=nonstopmode 试卷.tex
```

#### 长文件写入策略
LaTeX试卷通常600-1000行，子代理必须用分段写入法：
1. `cat > file.tex << 'LATEX_EOF'` 写前半部分（到填空题结束）
2. `cat >> file.tex << 'LATEX_EOF'` 追加后半部分（解答题+答案+\end{document}）
3. 写完后立即编译验证

#### Markdown仅作备用
只在明确不需要图形的场景（如语文作文、英语阅读理解纯文字部分）才用Markdown。即使用Markdown，也必须用pandoc+xelatex转PDF（不要用weasyprint）。


## 7. 参考真题结构（优先级最高）

- 若用户指定地区/卷型：先 `web_search` 找近年真题或权威样卷的"结构与分值"
- 仅参考结构与风格，不直接照抄真题题干


## 8. 踩坑经验（血泪总结）

### 8.1 生成质量类
1) **"修正题目"是最大红旗**：AI在解析中写"需要修正/重新设计/答案应为..."说明它自己都发现题目有问题，但懒得改题目本身。→ **prompt中必须明确禁止**，要求"发现问题就直接改好题目再输出"。
2) **答案前后不一致极常见**：解析推导得出答案X，但答案栏写的是Y，后面又"更正为X"。→ 交叉质询必查。
3) **单选题出现多解/无解**：AI可能设计出条件不足的题（如"等差数列给一个条件求公差"但条件不够），或四个选项都不对。→ 验算是唯一出路。
4) **多选题全ABCD不真实**：真实考试极少出现三道多选全选ABCD。
5) **常识性错误**：椭圆没有渐近线（只有双曲线有）、导数为零不一定是极值点（要看变号）等。

### 8.2 格式与工程类
6) **长文输出易截断**：GPT-5.2单次heredoc>500行会超时 → 分段写入。
7) **结构错误=整卷报废**：先锁定结构再出题，最后再复核总分。
8) **题图与文字一致**：写"如图"但实际无图 → Markdown版改为文字描述可解。
9) **子代理说完成不能信**：必须检查文件大小（24字节=空文件）、题目数量、总分。

### 8.3 流程类
10) **三路生成+交叉质询远优于单路生成**：单模型出题+自审=自己检查自己的作业，发现不了盲点。
11) **审查子代理必须用不同模型**：用同一个模型审查自己生成的题，容易重复同样的错误。
12) **串行spawn避免slot竞争**：并行3个子代理会导致gateway timeout，一个完成再下一个。
13) **prompt越精确，返工越少**：把结构规格表、禁止事项、输出格式要求全写进prompt，不要指望AI"自己理解"。
14) **weasyprint不能渲染LaTeX公式** → 必须用pandoc+xelatex，不要走pandoc→html→weasyprint路径
15) **pandoc转PDF时公式格式必须统一** → 全用$和$$，不要混用\(\)和\[\]
16) **交叉质询是最核心环节** → 单模型自审≈自己改自己作业，三模型交叉才能发现盲点。第一轮实测：三个模型生成的数学试卷全部有严重错误（答案矛盾、改题痕迹、条件不足），只有经过交叉质询才能筛出可用题
17) **验收报告必须量化** → 每题给出"通过/修正/淘汰"状态，不能只说"大致可以"
18) **文件大小是最快的质检手段** → 正常试卷md文件应>8KB（含解析），LaTeX文件应>15KB，<3KB几乎肯定截断了
19) **试卷必须用LaTeX+TikZ带图** → Markdown无法嵌入图形，真实试卷必须有配图。之前用Markdown出的试卷被退回因为"没有图片"。数学试卷需要函数曲线、几何图形、立体图形、圆锥曲线图等
20) **LaTeX模板要先读现有的** → `/root/.openclaw/workspace/gaokao/LaTeX版/` 有成熟模板，子代理必须先读模板再出题，保持排版风格一致
21) **参考真题风格** → 如有下载的真题（`gaokao/下载试卷/`），提取文本给子代理参考出题风格和难度，但不要抄题


## 9. PDF生成方案

### 9.1 推荐方案：pandoc + xelatex

Markdown转PDF（支持LaTeX公式、中文）：

```bash
pandoc 试卷.md -o 试卷.pdf \
  --pdf-engine=xelatex \
  -V CJKmainfont="Noto Sans CJK SC" \
  -V geometry:margin=2cm \
  -V geometry:a4paper \
  -V fontsize=11pt \
  -V linestretch=1.3 \
  --columns=80
```

如果公式复杂，确保md文件中的LaTeX公式格式正确：
- 行内公式: `$...$`
- 独立公式: `$$...$$`
- **不要用** `\( \)` 或 `\[ \]`，pandoc对`$`符号支持最好

### 9.2 不要用weasyprint

weasyprint是HTML/CSS引擎，**不支持LaTeX数学公式渲染**。之前尝试pandoc→html→weasyprint→pdf，所有`$...$`公式都显示为原始TeX文本，会出大量warning。

### 9.3 LaTeX版直接编译

```bash
xelatex -interaction=nonstopmode 试卷.tex
# 如需交叉引用，跑第二遍
xelatex -interaction=nonstopmode 试卷.tex
```


## 10. Markdown公式书写规范

在生成Markdown试卷时，公式格式**必须统一**：

```markdown
# 正确示例
行内公式用单美元号：已知 $a_n = 2n - 1$，求 $S_n$。
独立公式用双美元号：
$$S_n = \frac{n(a_1 + a_n)}{2}$$

# 错误示例（pandoc不兼容）
行内公式用 \(a_n = 2n - 1\)  ← 不要用
独立公式用 \[S_n = ...\]  ← 不要用
```

**子代理prompt中必须包含这条规则**："公式用 `$...$` 和 `$$...$$` 格式，不要用 `\(\)` 或 `\[\]`"
