# 交易系统架构图

```
┌──────────────────────────────────────────────────────────────┐
│                     Cron 定时调度                              │
│  ┌──────────┐  ┌──────────────┐  ┌───────────────────────┐   │
│  │ 盘中监控  │  │ 收盘复盘     │  │ 新闻简报 06/12/18    │   │
│  │ 每30min   │  │ 15:32        │  │                      │   │
│  └────┬─────┘  └──────┬───────┘  └──────────────────────┘   │
└───────┼───────────────┼──────────────────────────────────────┘
        │               │
        ▼               ▼
┌───────────────┐  ┌─────────────────────────┐
│ intraday_     │  │ review_engine.py         │
│ monitor.py    │  │ + stock_discovery.py     │
│               │  │ + deep_review.py         │
│ • 快照采集    │  │                          │
│ • 趋势分析    │  │ • 5-Why分析              │
│ • 持仓管理    │  │ • 参数调整               │
│ • watchlist   │  │ • 潜力股发现             │
│   扫描买入    │  │ • watchlist更新           │
└───┬───────────┘  └──────┬──────────────────┘
    │                     │
    ▼                     ▼
┌──────────────────────────────────────────┐
│           trading_engine.py               │
│                                          │
│  score_stock() 综合打分 0-100:            │
│  ┌──────────┐  ┌───────────┐             │
│  │技术分析30%│  │动量因子20% │            │
│  │MACD/RSI/ │  │5日/20日    │            │
│  │KDJ/BOLL  │  │涨幅/RS    │            │
│  └──────────┘  └───────────┘             │
│  ┌──────────┐  ┌───────────┐             │
│  │资金面 20%│  │情绪面 15% │  ← NEW!     │
│  │主力净流入│  │个股新闻+  │             │
│  │北向资金  │  │恐贪指数   │             │
│  └──────────┘  └───────────┘             │
│  ┌──────────┐                            │
│  │基本面 15%│  恐贪指数动态调阈值:       │
│  │PE/PB/市值│  <30 买入阈值-5            │
│  └──────────┘  >70 卖出阈值+5            │
│                                          │
│  execute_trade() → account.json 更新      │
└────────────┬─────────────────────────────┘
             │
             ▼
┌──────────────────────────────────────────┐
│         risk_manager.py  ← NEW!          │
│                                          │
│  • calculate_portfolio_risk()            │
│    - 单只集中度 >30% 警告               │
│    - 行业集中度 >40% 警告               │
│    - 仓位风险评级 high/medium/low        │
│                                          │
│  • check_drawdown_circuit_breaker()      │
│    - 峰值回撤 >10% → 熔断(停买)          │
│                                          │
│  • position_size_kelly()                 │
│    - 凯利公式计算最优仓位(半凯利)        │
└──────────────────────────────────────────┘
             │
             ▼
┌──────────────────────────────────────────┐
│         sentiment_enhanced.py  ← NEW!    │
│                                          │
│  • calculate_fear_greed() → 0-100        │
│    涨跌比(0.25) + 涨跌停比(0.15) +      │
│    量比(0.20) + 新闻情绪(0.20) +         │
│    北向资金(0.20)                        │
│                                          │
│  • analyze_stock_sentiment() → -10~+10   │
│    东财个股新闻搜索 + 情绪词典打分       │
└──────────────────────────────────────────┘
             │
             ▼
┌──────────────────────────────────────────┐
│           数据层                          │
│  fetch_stock_data.py (新浪/东财/BaoStock) │
│  news_sentiment.py (东财7x24/新浪新闻)   │
│  technical_analysis.py (MA/EMA/MACD/...) │
│  factor_model.py (5因子模型)             │
└──────────────────────────────────────────┘
             │
             ▼
┌──────────────────────────────────────────┐
│           存储                           │
│  account.json     持仓/现金/峰值         │
│  watchlist.json   关注列表               │
│  strategy_params  策略参数(动态加载)     │
│  transactions     交易记录               │
│  data/            快照/发现/恐贪历史     │
└──────────────────────────────────────────┘
             │
             ▼
    ┌────────────────┐
    │  飞书通知推送   │
    │  (有信号时发)   │
    └────────────────┘
```

## GitHub 参考项目

本系统参考了以下开源项目的架构思路进行增强：

| 项目 | Star | 参考要点 |
|------|------|----------|
| [TradingAgents](https://github.com/TauricResearch/TradingAgents) | 2.3k+ | 多Agent架构（基本面/情绪/新闻/技术分析师 + 研究团队 + 交易员 + 风控）|
| [AI_Agent_Trader](https://github.com/AloshkaD/AI_Agent_Trader) | — | VaR/CVaR风险模型、蒙特卡洛模拟、凯利公式仓位管理 |
| [PrimoAgent](https://github.com/...) | — | 4步Pipeline（数据采集→技术分析→新闻情报→组合管理）|
| [stock-scanner](https://github.com/DR-lin-eng/stock-scanner) | — | A股25项财务指标、多AI模型情绪分析 |
| [ai_quant_trade](https://github.com/charliedream1/ai_quant_trade) | — | A股量化全系统，ML/DL/RL策略 |
| [FinRobot](https://github.com/AI4Finance-Foundation/FinRobot) | — | 开源AI Agent金融分析平台 |

### 我们借鉴的核心思路
1. **多维情绪分析** — 不只关键词，加入恐贪指数（类CNN Fear&Greed）
2. **风控独立模块** — 回撤熔断、凯利公式、集中度检查
3. **多源选股** — 连涨强势股、机构增持，不只看榜单
4. **情绪→阈值联动** — 恐贪指数动态调整买卖触发线（逆向投资）
